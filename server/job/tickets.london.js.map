{"version":3,"sources":["job/tickets.london.js"],"names":["job","cheerio","require","req","webSiteName","sitePrefix","webSiteID","async","saveToDB","moment","page","resp","types","eventType","performerType","link","index","currentType","respondWithResult","res","statusCode","entity","status","json","handleError","err","send","scrape","url","cb","body","console","log","$","load","pageData","events","length","datePre","arr","each","i","element","attribs","class","el","html","text","trim","split","p","date","tz","children","data","format","name","isNaN","obj","attr","location","startDate","performer","price","eventImage","active","website","push","locationCB","getWebSiteID","findOne","then","response","_id","getHtmlPage","create","websiteUrl","rating","logoUrl","defaultImageUrl","message","goToNextCategory","toString","save","checkWebsiteInDB"],"mappings":"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","file":"job/tickets.london.js","sourcesContent":["\"use strict\";\n\n// Import the dependencies\nimport website from '../api/website/website.model';\n\nconst cheerio = require(\"cheerio\"), req = require(\"tinyreq\");\nconst webSiteName = \"tickets.london\";\nconst sitePrefix = 'http://tickets.london';\nvar webSiteID = \"\";\nvar async = require('async');\nvar saveToDB = require('./util/saveToDB');\nvar moment = require('moment-timezone');\nvar page = 0;\nvar resp;\nconst types = [\n\n  {\n    eventType: 'MusicEvent',\n    performerType: 'MusicPerformer',\n    link: 'http://tickets.london/search?browseorder=soonest&dend=26%2F12%2F2016&distance=0&availableonly=False&showfavourites=True&se=False&s=music&pageSize=30&pageIndex='\n  },\n  {\n    eventType: 'SportEvent',\n    performerType: 'sportPerformer',\n    link: 'http://tickets.london/search?browseorder=soonest&dend=26%2F12%2F2016&distance=0&availableonly=False&showfavourites=True&se=False&s=sport&pageSize=30&pageIndex='\n  },\n  {\n    eventType: 'TheaterEvent',\n    performerType: 'TheaterPerformer',\n    link: 'http://tickets.london/search?browseorder=soonest&dend=26%2F12%2F2016&distance=0&availableonly=False&showfavourites=True&se=False&s=theatre&pageSize=30&pageIndex='\n  }\n]\nvar index = 0\nvar currentType = types[0];\n// Define the scrape function\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function (entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function (err) {\n    res.status(statusCode).send(err);\n  };\n}\nfunction scrape(url, cb) {\n  // 1. Create the request\n  req(url, (err, body) => {\n    if (err) {\n      console.log(\"error:\", err)\n      return cb(err);\n    }\n\n    // 2. Parse the HTML\n    let $ = cheerio.load(body), pageData = [];\n    let events = $('#search-results .results-div, #search-results article');\n    if (events.length == 0) {\n      console.log('events.length', events.length)\n      cb(true, \"no more data\");\n    } else {\n      let datePre = [];\n      let arr = [];\n      events.each(function (i, element) {\n        ///console.log(element.attribs.class)\n        if (element.attribs.class === 'results-div') {\n          let el = cheerio.load($(this).html());\n          datePre = el('span').text().trim().split(' ');\n          //console.log(el('span').text().trim());\n        } else {\n          let el = cheerio.load($(this).html());\n          let p = el('p');\n          let date = moment.tz(datePre[1] + ' ' + p[1].children[0].data, 'YYYY dddd Do MMMM at h:mm A', \"Europe/London\").format('x');\n          let name = '';\n          if (el('h3 a').length > 1) {\n            let arr = el('h3 a')\n            //console.log('count ' + el('h3 a').length, arr);\n            name = arr[0].children[0].data;\n            //console.log('count ' + el('h3 a').length, arr[0].children[0].data);\n\n          } else {\n            name = el('h3 a').text();\n            //console.log('count 1', el('h3 a').text());\n          }\n          if (!isNaN(date)) {\n            let obj = {\n              '@type': currentType.eventType,\n              name: name,\n              url: sitePrefix + el('h3 a').attr(\"href\"),\n              location: {\n                \"name\": el('p a').text(),\n                \"link\": el('p a').attr(\"href\")\n              },\n              startDate: date,\n              performer: {\n                '@type': currentType.performerType,\n                'name': sitePrefix + el('h3 a').text(),\n                'sameAs': sitePrefix + el('h3 a').attr(\"href\")\n              },\n              price: '',\n              eventImage: el('img').attr(\"src\"),\n              active: true,\n              website: webSiteID\n            };\n            console.log('Image:', obj.eventImage);\n            arr.push(obj);\n          }\n        }\n      })\n      cb(null, arr);\n    }\n  });\n}\n\n// Extract some data from my website\nfunction locationCB(data) {\n\n  respondWithResult(data, 200);\n}\nfunction getWebSiteID(res) {\n  website.findOne({name: webSiteName})\n    .then(function (response) {\n      if (response !== null) {\n        webSiteID = response._id;\n        //parceResult(data, res);\n        getHtmlPage();\n      } else {\n        website.create({\n          name: webSiteName,\n          websiteUrl: \"http://tickets.london\",\n          rating: 5,\n          logoUrl: \"\",\n          defaultImageUrl: \"\",\n          active: true\n        }).then(function (response) {\n          webSiteID = response._id;\n          getHtmlPage();\n        });\n      }\n    });\n}\nexport function job(req, res) {\n  console.log(\"Started\");\n  page = 0;\n  index = 0;\n  currentType = types[0];\n  getWebSiteID();\n  resp = res;\n  return res.status(200).json({message: \"process started\"})\n}\nfunction goToNextCategory() {\n  index = index + 1;\n  currentType = types[index];\n  page = 0;\n  getHtmlPage();\n}\nfunction getHtmlPage() {\n  page++;\n  //console.log(\"Get Page:\", page);\n  //console.log('Page:', currentType.link + page.toString());\n  scrape(currentType.link + page.toString()\n    , (err, data) => {\n\n      if (err) {\n        console.log(index);\n        if (index < 2) {\n          goToNextCategory()\n        } else {\n          console.log(\"End of process\");\n          return;\n        }\n        //process.exit();\n\n      } else {\n        /// parceResult(data);\n        saveToDB.save(data, webSiteID, getHtmlPage);\n      }\n    });\n}\n\nfunction checkWebsiteInDB() {\n\n}\n"],"sourceRoot":"/source/"}