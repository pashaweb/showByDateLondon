{"version":3,"sources":["job/songclick.js"],"names":["job","cheerio","require","req","songkickName","songkickID","async","saveToDB","moment","page","resp","respondWithResult","res","statusCode","entity","status","json","handleError","err","send","scrape","url","cb","body","console","log","$","load","pageData","count","length","each","i","elem","el","html","obj","JSON","parse","text","attr","eventImage","date","startDate","format","push","locationCB","data","getSongKickID","findOne","name","then","response","_id","getHtmlPage","create","websiteUrl","rating","logoUrl","defaultImageUrl","active","message","save","checkWebsiteInDB"],"mappings":"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","file":"job/songclick.js","sourcesContent":["\"use strict\"\n\n// Import the dependencies\n// import _ from 'lodash';\n// import show_by_date_event from '../api/event/event.model';\nimport website from '../api/website/website.model';\n\nconst cheerio = require(\"cheerio\"), req = require(\"tinyreq\");\nconst songkickName = \"Songkick\";\nvar songkickID = \"\";\nvar async = require('async');\nvar saveToDB = require('./util/saveToDB');\nvar moment = require('moment');\nvar page = 0;\nvar resp;\n// Define the scrape function\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function (entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function (err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nfunction scrape(url, cb) {\n  // 1. Create the request\n  req(url, (err, body) => {\n    if (err) {\n      console.log(\"error:\", err)\n      return cb(err);\n    }\n    // 2. Parse the HTML\n    let $ = cheerio.load(body), pageData = [];\n    var count = $(\"#event-listings li[title]\").length;\n    if (count > 0) {\n      $(\"#event-listings li[title]\").each(function (i, elem) {\n        let el = cheerio.load($(this).html());\n        let obj = JSON.parse(el(\".microformat script\").text());\n        obj = obj[0]\n        obj.url = \"https://www.songkick.com\" + el(\".thumb\").attr(\"href\");\n        obj.eventImage = el('.thumb img').attr(\"src\");\n        var date=moment(obj.startDate).format('x');\n        obj.startDate=date;\n        pageData.push(obj);\n      });\n      cb(null, pageData);\n    } else {\n      cb(true, \"no more data\");\n\n    }\n\n\n  });\n}\n\n// Extract some data from my website\nfunction locationCB(data) {\n\n  respondWithResult(data, 200);\n}\nfunction getSongKickID(res) {\n  website.findOne({name: songkickName})\n    .then(function (response) {\n      if (response !== null) {\n        songkickID = response._id;\n        //parceResult(data, res);\n        getHtmlPage();\n      } else {\n        website.create({\n          name: songkickName,\n          websiteUrl: \"https://www.songkick.com\",\n          rating: 5,\n          logoUrl: \"https://www.songkick.com\",\n          defaultImageUrl: \"http://assets.sk-static.com/assets/default_images/huge_avatar/default-event-798b09a.png\",\n          active: true\n        }).then(function (response) {\n          songkickID = response._id;\n          getHtmlPage();\n        });\n      }\n    });\n}\nexport function job(req, res) {\n  console.log(\"Started\");\n  page = 0;\n  getSongKickID();\n  resp=res;\n  return res.status(200).json({message: \"process started\"})\n}\n\nfunction getHtmlPage() {\n  page++;\n  console.log(\"Get Page:\", page);\n  scrape(\"https://www.songkick.com/metro_areas/24426-uk-london?utf8=true&page=\" + page //&filters[minDate]=\"+ dateFrom + \"&filters[maxDate]=\"+ dateTo + \"#date-filter-form\"\n    , (err, data) => {\n\n      //check the db for a songlick website\n      if (err) {\n        //process.exit();\n        console.log(\"End of process\");\n        return;\n      } else {\n       /// parceResult(data);\n        saveToDB.save(data, songkickID, getHtmlPage);\n      }\n    });\n}\n\n\nfunction checkWebsiteInDB() {\n\n}\n"],"sourceRoot":"/source/"}