{"version":3,"sources":["job/londontheatredirect.js"],"names":["job","moment","require","Client","client","webSiteName","saveToDB","venues","events","webSiteID","args","headers","req","res","getWebSiteID","status","json","message","findOne","name","then","response","_id","getVenues","create","websiteUrl","rating","logoUrl","defaultImageUrl","active","get","data","venuesTemp","Venues","map","loc","VenueId","City","Address","Postcode","Name","i","length","set","getEvents","Events","venue","ev","url","EventDetailUrl","location","startDate","tz","StartDate","format","endDate","EndDate","performer","price","eventImage","SmallImageUrl","website","save","endProcess","console","log"],"mappings":"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","file":"londontheatredirect.js","sourcesContent":["import website from '../api/website/website.model';\r\nlet moment = require('moment-timezone');\r\nconst Client = require('node-rest-client').Client;\r\nconst client = new Client();\r\nconst webSiteName = \"londontheatredirect.com\";\r\nlet saveToDB = require('./util/saveToDB');\r\nlet venues = new Map();\r\nlet events = [];\r\nlet webSiteID = \"\";\r\nconst args = {\r\n    headers: {\r\n        'Api-Key': 'gtemuger8779r4thqth7ptab',\r\n        'Content-Type': 'application/json'\r\n    }\r\n};\r\n\r\nexport function job(req, res) {\r\n    getWebSiteID();\r\n    return res.status(200).json({ message: \"process started\" })\r\n}\r\n\r\nfunction getWebSiteID(res) {\r\n    website.findOne({ name: webSiteName })\r\n        .then(function(response) {\r\n            if (response !== null) {\r\n                webSiteID = response._id;\r\n                //parceResult(data, res);\r\n                getVenues();\r\n            } else {\r\n                website.create({\r\n                    name: webSiteName,\r\n                    websiteUrl: \"https://www.londontheatredirect.com\",\r\n                    rating: 5,\r\n                    logoUrl: \"\",\r\n                    defaultImageUrl: \"\",\r\n                    active: true\r\n                }).then(function(response) {\r\n                    webSiteID = response._id;\r\n                    getVenues();\r\n                });\r\n            }\r\n        });\r\n}\r\n\r\nfunction getVenues() {\r\n    venues = new Map();\r\n    client.get(\"https://api.londontheatredirect.com/rest/v2/Venues\", args,\r\n        function(data, response) {\r\n            let venuesTemp = data.Venues.map(loc => {\r\n                return {\r\n                    \"VenueId\": loc.VenueId,\r\n                    \"type\": \"Place\",\r\n                    \"address\": {\r\n                        \"type\": \"PostalAddress\",\r\n                        \"addressLocality\": loc.City,\r\n                        \"streetAddress\": loc.Address,\r\n                        \"postalCode\": loc.Postcode\r\n                    },\r\n                    \"name\": loc.Name\r\n                }\r\n            });\r\n            for (var i = 0; i < venuesTemp.length; i++) {\r\n                venues.set(venuesTemp[i].VenueId, venuesTemp[i])\r\n            }\r\n            getEvents();\r\n        });\r\n}\r\n\r\nfunction getEvents() {\r\n    events = [];\r\n    client.get(\"https://api.londontheatredirect.com/rest/v2/Events\", args,\r\n        function(data, response) {\r\n\r\n            events = data.Events.map(ev => {\r\n                let venue = venues.get(ev.VenueId);\r\n                return {\r\n                    '@type': 'TheaterEvent',\r\n                    name: ev.Name,\r\n                    url: ev.EventDetailUrl,\r\n                    location: venue,\r\n                    startDate: moment.tz(ev.StartDate, \"Europe/London\").format('x'), ///el('.event-meta strong').attr('content'),\r\n                    endDate: moment.tz(ev.EndDate, \"Europe/London\").format('x'),\r\n                    performer: [{\r\n                        '@type': 'TheaterPerformer',\r\n                        'name': ev.Name\r\n                            //'sameAs': sitePrefix + el('h3 a').attr(\"href\")\r\n                    }],\r\n                    price: '',\r\n                    eventImage: ev.SmallImageUrl,\r\n                    active: true,\r\n                    website: webSiteID\r\n                }\r\n            });\r\n            saveToDB.save(events, webSiteID, endProcess);\r\n\r\n        });\r\n}\r\n\r\nfunction endProcess() {\r\n    console.log('End Process')\r\n}"]}