{"version":3,"sources":["job/util/saveToDB.js"],"names":["save","locationToID","require","eventTypeToID","performerToID","async","arr","websiteID","cb","out","eachSeries","item","next","outItem","waterfall","callback","tempName","name","toLowerCase","query","name_lower","startDate","endDate","findOne","then","response","res","favorite","parallel","eventTypeID","getID","location","performers","performer","err","results","eventType","hasFavorites","idsList","push","url","website","price","eventImage","active","console","log","create","result"],"mappings":"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","file":"saveToDB.js","sourcesContent":["import show_by_date_event from '../../api/event/event.model';\nimport Favorite from '../../api/favorite/favorite.model'\nvar locationToID = require('./locationToID');\nvar eventTypeToID = require('./eventTypeToID');\nvar performerToID = require('./performerToID');\nvar async = require('async');\nexport function save(arr, websiteID, cb) {\n    let out = [];\n    async.eachSeries(arr,\n        function(item, next) {\n            let outItem = {};\n            async.waterfall([\n                function(callback) {\n                    let tempName = item.name.toLowerCase();\n                    let query = item['@type'] == 'TheaterEvent' ? { name_lower: tempName } : { name_lower: tempName, startDate: item.startDate, endDate: item.endDate }\n                    show_by_date_event.findOne({ name_lower: tempName, startDate: item.startDate, endDate: item.endDate })\n                        .then(function(response) {\n                            if (response !== null) {\n                                callback(true);\n                            } else {\n                                callback(null);\n                            }\n                        });\n                },\n                function(callback) {\n                    let tempName = item.name.toLowerCase();\n                    Favorite.findOne({ name_lower: tempName })\n                        .then(function(res) {\n                            if (res != null) {\n                                outItem.favorite = true;\n                            } else {\n                                outItem.favorite = false;\n                            }\n                            callback(null);\n                        });\n                },\n                function(callback) {\n                    //console.log(\"not exist\");\n                    //get propretis ids\n                    async.parallel({\n                        eventTypeID: function(callback) {\n                            eventTypeToID.getID(item['@type'], callback);\n                        },\n                        location: function(callback) {\n                            locationToID.getID(item.location, callback);\n                        },\n                        performers: function(callback) {\n                            performerToID.getID(item.performer, callback);\n                        }\n                    }, function(err, results) {\n                        // results is now equals to: {one: 1, two: 2}\n                        //console.log(\"results\", results);\n                        outItem.eventType = results.eventTypeID;\n                        if (results.performers.hasFavorites) {\n                            outItem.favorite = true;\n                        }\n                        outItem.location = results.location;\n                        outItem.performer = results.performers.idsList;\n                        out.push(outItem);\n                        callback(null)\n                    });\n                    // arg1 now equals 'one' and arg2 now equals 'two'\n                    //callback(null, 'three');\n                },\n                function(callback) {\n\n                    outItem.name = item.name;\n                    outItem.name_lower = item.name.toLowerCase();\n                    outItem.url = item.url;\n                    outItem.startDate = item.startDate;\n                    outItem.endDate = item.endDate;\n                    outItem.website = websiteID;\n                    outItem.price = null;\n                    outItem.eventImage = item.eventImage;\n                    outItem.active = true;\n                    console.log(\"Create: \", outItem.name);\n\n                    show_by_date_event.create(outItem)\n                        .then(function(res) {\n                            callback(null, 'done');\n                        }, function(err) {\n                            console.log('error:', err);\n                            callback(null, 'done');\n                            // handle error here.\n                        })\n                        // arg1 now equals 'three')\n\n                }\n            ], function(err, result) {\n                if (err) {\n                    next();\n                } else {\n                    out.push(outItem);\n                    next();\n                }\n            });\n        },\n        function(err) {\n            // console.log(out);\n            //return res.status(200).json(out)\n            cb();\n        })\n}"]}