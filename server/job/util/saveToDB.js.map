{"version":3,"sources":["job/util/saveToDB.js"],"names":["save","locationToID","require","eventTypeToID","performerToID","async","arr","websiteID","cb","out","eachSeries","item","next","outItem","waterfall","callback","findOne","name","then","response","parallel","eventTypeID","getID","location","performers","performer","err","results","eventType","push","url","startDate","website","price","eventImage","active","create","res","result"],"mappings":";;;;;QAQgBA,I,GAAAA,I;;AALhB;;;;;;AACA,IAAIC,eAAeC,QAAQ,gBAAR,CAAnB,C,CAJA;;;;AAKA,IAAIC,gBAAgBD,QAAQ,iBAAR,CAApB;AACA,IAAIE,gBAAgBF,QAAQ,iBAAR,CAApB;AACA,IAAIG,QAAQH,QAAQ,OAAR,CAAZ;AACO,SAASF,IAAT,CAAcM,GAAd,EAAmBC,SAAnB,EAA8BC,EAA9B,EAAkC;AACvC,MAAIC,MAAM,EAAV;AACAJ,QAAMK,UAAN,CAAiBJ,GAAjB,EACE,UAAUK,IAAV,EAAgBC,IAAhB,EAAsB;AACpB,QAAIC,UAAU,EAAd;AACAR,UAAMS,SAAN,CAAgB,CACd,UAAUC,QAAV,EAAoB;AAClB,sBAAmBC,OAAnB,CAA2B,EAACC,MAAMN,KAAKM,IAAZ,EAA3B,EACGC,IADH,CACQ,UAAUC,QAAV,EAAoB;AACxB,YAAIA,aAAa,IAAjB,EAAuB;AACrBJ,mBAAS,IAAT;AACD,SAFD,MAEO;AACLA,mBAAS,IAAT;AACD;AACF,OAPH;AAQD,KAVa,EAWd,UAAUA,QAAV,EAAoB;AAClB;AACA;AACAV,YAAMe,QAAN,CAAe;AACXC,qBAAa,qBAAUN,QAAV,EAAoB;AAC/BZ,wBAAcmB,KAAd,CAAoBX,KAAK,OAAL,CAApB,EAAmCI,QAAnC;AACD,SAHU;AAIXQ,kBAAU,kBAAUR,QAAV,EAAoB;AAC5Bd,uBAAaqB,KAAb,CAAmBX,KAAKY,QAAxB,EAAkCR,QAAlC;AACD,SANU;AAOXS,oBAAY,oBAAUT,QAAV,EAAoB;AAC9BX,wBAAckB,KAAd,CAAoBX,KAAKc,SAAzB,EAAoCV,QAApC;AACD;AATU,OAAf,EAWI,UAAUW,GAAV,EAAeC,OAAf,EAAwB;AACxB;AACA;AACAd,gBAAQe,SAAR,GAAoBD,QAAQN,WAA5B;AACAR,gBAAQU,QAAR,GAAmBI,QAAQJ,QAA3B;AACAV,gBAAQY,SAAR,GAAoBE,QAAQH,UAA5B;AACAf,YAAIoB,IAAJ,CAAShB,OAAT;AACAE,iBAAS,IAAT;AACD,OAnBH;AAoBA;AACA;AACD,KApCa,EAqCd,UAAUA,QAAV,EAAoB;;AAElBF,cAAQI,IAAR,GAAeN,KAAKM,IAApB;AACAJ,cAAQiB,GAAR,GAAcnB,KAAKmB,GAAnB;AACAjB,cAAQkB,SAAR,GAAoBpB,KAAKoB,SAAzB;AACAlB,cAAQmB,OAAR,GAAkBzB,SAAlB;AACAM,cAAQoB,KAAR,GAAgB,IAAhB;AACApB,cAAQqB,UAAR,GAAqBvB,KAAKuB,UAA1B;AACArB,cAAQsB,MAAR,GAAiB,IAAjB;AACD;;AAEC,sBAAmBC,MAAnB,CAA0BvB,OAA1B,EACGK,IADH,CACQ,UAAUmB,GAAV,EAAe;AACnBtB,iBAAS,IAAT,EAAe,MAAf;AACD,OAHH;AAIA;AAED,KAtDa,CAAhB,EAuDG,UAAUW,GAAV,EAAeY,MAAf,EAAuB;AACxB,UAAIZ,GAAJ,EAAS;AACPd;AACD,OAFD,MAEO;AACLH,YAAIoB,IAAJ,CAAShB,OAAT;AACAD;AACD;AACF,KA9DD;AA+DD,GAlEH,EAmEE,UAAUc,GAAV,EAAe;AACb;AACA;AACAlB;AACD,GAvEH;AAwED","file":"saveToDB.js","sourcesContent":["/**\n * Created by Pavel.Kogan on 14/08/2016.\n */\nimport show_by_date_event from '../../api/event/event.model';\nvar locationToID = require('./locationToID');\nvar eventTypeToID = require('./eventTypeToID');\nvar performerToID = require('./performerToID');\nvar async = require('async');\nexport function save(arr, websiteID, cb) {\n  let out = [];\n  async.eachSeries(arr,\n    function (item, next) {\n      let outItem = {};\n      async.waterfall([\n        function (callback) {\n          show_by_date_event.findOne({name: item.name})\n            .then(function (response) {\n              if (response !== null) {\n                callback(true);\n              } else {\n                callback(null);\n              }\n            });\n        },\n        function (callback) {\n          //console.log(\"not exist\");\n          //get propretis ids\n          async.parallel({\n              eventTypeID: function (callback) {\n                eventTypeToID.getID(item['@type'], callback);\n              },\n              location: function (callback) {\n                locationToID.getID(item.location, callback);\n              },\n              performers: function (callback) {\n                performerToID.getID(item.performer, callback);\n              }\n            }\n            , function (err, results) {\n              // results is now equals to: {one: 1, two: 2}\n              //console.log(\"results\", results);\n              outItem.eventType = results.eventTypeID;\n              outItem.location = results.location;\n              outItem.performer = results.performers;\n              out.push(outItem);\n              callback(null)\n            });\n          // arg1 now equals 'one' and arg2 now equals 'two'\n          //callback(null, 'three');\n        },\n        function (callback) {\n\n          outItem.name = item.name;\n          outItem.url = item.url;\n          outItem.startDate = item.startDate;\n          outItem.website = websiteID;\n          outItem.price = null;\n          outItem.eventImage = item.eventImage;\n          outItem.active = true;\n         // console.log(\"Create: \", outItem.name);\n\n          show_by_date_event.create(outItem)\n            .then(function (res) {\n              callback(null, 'done');\n            })\n          // arg1 now equals 'three')\n\n        }\n      ], function (err, result) {\n        if (err) {\n          next();\n        } else {\n          out.push(outItem);\n          next();\n        }\n      });\n    },\n    function (err) {\n      // console.log(out);\n      //return res.status(200).json(out)\n      cb();\n    })\n}\n"]}