{"version":3,"sources":["job/util/saveToDB.js"],"names":["save","locationToID","require","eventTypeToID","performerToID","async","arr","websiteID","cb","out","eachSeries","item","next","outItem","waterfall","callback","tempName","name","toLowerCase","findOne","name_lower","startDate","endDate","then","response","res","favorite","parallel","eventTypeID","getID","location","performers","performer","err","results","eventType","hasFavorites","idsList","push","url","website","price","eventImage","active","console","log","create","result"],"mappings":"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","file":"saveToDB.js","sourcesContent":["import show_by_date_event from '../../api/event/event.model';\nimport Favorite from '../../api/favorite/favorite.model'\nvar locationToID = require('./locationToID');\nvar eventTypeToID = require('./eventTypeToID');\nvar performerToID = require('./performerToID');\nvar async = require('async');\nexport function save(arr, websiteID, cb) {\n    let out = [];\n    async.eachSeries(arr,\n        function(item, next) {\n            let outItem = {};\n            async.waterfall([\n                function(callback) {\n                    let tempName = item.name.toLowerCase();\n                    show_by_date_event.findOne({ name_lower: tempName, startDate: item.startDate, endDate: item.endDate })\n                        .then(function(response) {\n                            if (response !== null) {\n                                callback(true);\n                            } else {\n                                callback(null);\n                            }\n                        });\n                },\n                function(callback) {\n                    let tempName = item.name.toLowerCase();\n                    Favorite.findOne({ name_lower: tempName })\n                        .then(function(res) {\n                            if (res != null) {\n                                outItem.favorite = true;\n                            } else {\n                                outItem.favorite = false;\n                            }\n                            callback(null);\n                        });\n                },\n                function(callback) {\n                    //console.log(\"not exist\");\n                    //get propretis ids\n                    async.parallel({\n                        eventTypeID: function(callback) {\n                            eventTypeToID.getID(item['@type'], callback);\n                        },\n                        location: function(callback) {\n                            locationToID.getID(item.location, callback);\n                        },\n                        performers: function(callback) {\n                            performerToID.getID(item.performer, callback);\n                        }\n                    }, function(err, results) {\n                        // results is now equals to: {one: 1, two: 2}\n                        //console.log(\"results\", results);\n                        outItem.eventType = results.eventTypeID;\n                        if (results.performers.hasFavorites) {\n                            outItem.favorite = true;\n                        }\n                        outItem.location = results.location;\n                        outItem.performer = results.performers.idsList;\n                        out.push(outItem);\n                        callback(null)\n                    });\n                    // arg1 now equals 'one' and arg2 now equals 'two'\n                    //callback(null, 'three');\n                },\n                function(callback) {\n\n                    outItem.name = item.name;\n                    outItem.name_lower = item.name.toLowerCase();\n                    outItem.url = item.url;\n                    outItem.startDate = item.startDate;\n                    outItem.endDate = item.endDate;\n                    outItem.website = websiteID;\n                    outItem.price = null;\n                    outItem.eventImage = item.eventImage;\n                    outItem.active = true;\n                    console.log(\"Create: \", outItem.name);\n\n                    show_by_date_event.create(outItem)\n                        .then(function(res) {\n                            callback(null, 'done');\n                        }, function(err) {\n                            console.log('error:', err);\n                            callback(null, 'done');\n                            // handle error here.\n                        })\n                        // arg1 now equals 'three')\n\n                }\n            ], function(err, result) {\n                if (err) {\n                    next();\n                } else {\n                    out.push(outItem);\n                    next();\n                }\n            });\n        },\n        function(err) {\n            // console.log(out);\n            //return res.status(200).json(out)\n            cb();\n        })\n}"]}