{"version":3,"sources":["job/london.eventful.js"],"names":["job","cheerio","require","req","webSiteName","sitePrefix","webSiteID","async","saveToDB","moment","page","resp","types","eventType","performerType","link","index","currentType","respondWithResult","res","statusCode","entity","status","json","handleError","err","send","scrape","url","cb","body","console","log","$","load","pageData","events","length","arr","each","i","element","el","html","obj","name","attr","location","text","startDate","tz","format","performer","price","eventImage","active","website","push","locationCB","data","getWebSiteID","findOne","then","response","_id","getHtmlPage","create","websiteUrl","rating","logoUrl","defaultImageUrl","message","goToNextCategory","toString","save","checkWebsiteInDB"],"mappings":"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","file":"london.eventful.js","sourcesContent":["\"use strict\";\n\n// Import the dependencies\nimport website from '../api/website/website.model';\n\nconst cheerio = require(\"cheerio\"), req = require(\"tinyreq\");\nconst webSiteName = \"london.eventful.com\";\nconst sitePrefix = 'http://london.eventful.com';\nvar webSiteID = \"\";\nvar async = require('async');\nvar saveToDB = require('./util/saveToDB');\nvar moment = require('moment-timezone');\nvar page = 0;\nvar resp;\nconst types = [\n\n  {\n    eventType: 'MusicEvent',\n    performerType: 'MusicPerformer',\n    link: 'http://london.eventful.com/v2/tools/events/faceted_search?' +\n    'type=asynch' +\n    '&location_type=metro_id&location_id=67' +\n    '&sort=rec&page_size=100' +\n    '&when=future&worldwide=0' +\n    '&category=music' +\n    '&_s_category=music' +\n    '&page_number='\n  },\n  {\n    eventType: 'SportEvent',\n    performerType: 'sportPerformer',\n    link: 'http://london.eventful.com/v2/tools/events/faceted_search?' +\n    'type=asynch' +\n    '&location_type=metro_id&location_id=67' +\n    '&sort=rec&page_size=100' +\n    '&when=future&worldwide=0' +\n    '&category=sports' +\n    '&_s_category=sports' +\n    '&page_number='\n  }\n  // ,\n  // {\n  //   eventType: 'TheaterEvent',\n  //   performerType: 'TheaterPerformer',\n  //   link: 'http://tickets.london/search?browseorder=soonest&dend=26%2F12%2F2016&distance=0&availableonly=False&showfavourites=True&se=False&s=theatre&pageSize=30&pageIndex='\n  // }\n]\nvar index = 0\nvar currentType = types[0];\n// Define the scrape function\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function (entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function (err) {\n    res.status(statusCode).send(err);\n  };\n}\nfunction scrape(url, cb) {\n  // 1. Create the request\n  req(url, (err, body) => {\n    if (err) {\n      console.log(\"error:\", err)\n      return cb(err);\n    }\n\n    // 2. Parse the HTML\n    let $ = cheerio.load(body), pageData = [];\n    let events = $('#events-list li[itemscope]');\n    if (events.length == 0) {\n      console.log('events.length', events.length)\n      cb(true, \"no more data\");\n    } else {\n      let arr=[];\n      events.each(function (i, element) {\n\n        let el = cheerio.load($(this).html());\n        let obj = {\n          '@type': currentType.eventType,\n          name: el('h4 a').attr('title'),\n          url: el('.tn-frame').attr(\"href\"),\n          location: {\n            \"name\": el('.event-meta span').text()\n            //,\n            //\"link\": el('p a').attr(\"href\")\n          },\n          startDate:moment.tz(moment(el('.event-meta strong').attr('content')), \"Europe/London\").format('x'),  ///el('.event-meta strong').attr('content'),\n          performer: {\n            '@type': currentType.performerType,\n            'name':  el('h4 a').attr('title'),\n            //'sameAs': sitePrefix + el('h3 a').attr(\"href\")\n          },\n          price: '',\n          eventImage:el('.tn-frame img').attr(\"src\"),\n          active: true,\n          website: webSiteID\n        };\n        //console.log('Object:', obj);\n        //console.log('url:', obj.eventImage);\n        arr.push(obj);\n      })\n      cb(null, arr);\n    }\n  });\n}\n\n// Extract some data from my website\nfunction locationCB(data) {\n\n  respondWithResult(data, 200);\n}\nfunction getWebSiteID(res) {\n  website.findOne({name: webSiteName})\n    .then(function (response) {\n      if (response !== null) {\n        webSiteID = response._id;\n        //parceResult(data, res);\n        getHtmlPage();\n      } else {\n        website.create({\n          name: webSiteName,\n          websiteUrl: \"http://london.eventful.com\",\n          rating: 5,\n          logoUrl: \"\",\n          defaultImageUrl: \"\",\n          active: true\n        }).then(function (response) {\n          webSiteID = response._id;\n          getHtmlPage();\n        });\n      }\n    });\n}\nexport function job(req, res) {\n  console.log(\"Started\");\n  page = 0;\n  index = 0;\n  currentType = types[0];\n  getWebSiteID();\n  resp = res;\n  return res.status(200).json({message: \"process started\"})\n}\nfunction goToNextCategory() {\n  index = index + 1;\n  currentType = types[index];\n  page = 0;\n  getHtmlPage();\n}\nfunction getHtmlPage() {\n  page++;\n  //console.log(\"Get Page:\", page);\n  //console.log('Page:', currentType.link + page.toString());\n  scrape(currentType.link + page.toString()\n    , (err, data) => {\n\n      if (err) {\n        console.log(index);\n        if (index < 1) {\n          goToNextCategory()\n        } else {\n          console.log(\"End of process\");\n          return;\n        }\n        //process.exit();\n\n      } else {\n        /// parceResult(data);\n        saveToDB.save(data, webSiteID, getHtmlPage);\n      }\n    });\n}\n\nfunction checkWebsiteInDB() {\n\n}\n"]}